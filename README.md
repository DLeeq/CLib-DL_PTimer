# DL_PTimer
**Простая библиотека для гибкого и удобного создания и управления программными таймерами с минимальным интервалом 1 мс. Основана на C и HAL.**
## Оглавление
1. [Описание](#описание)
2. [Установка](#установка)
3. [Использование](#использование)
4. [Совместимость](#совместимость)
5. [Версии](#версии)
6. [Обратная связь](#обратная-связь)
## Описание  
Библиотека предлагает простой и понятный интерфейс для создания и обработки программных таймеров с минимальным интервалом 1мс.
- Количество создаваемых таймеров не ограничено
- Задание интервалов времени в:
  - Миллисекундах
  - Секундах
  - Минутах
  - Часах
  - Днях 
- Максимальный временной интервал ограничен 32-битной переменной счетчика. ~49.7 дней.
- Интерфейс:
  - Запуск таймера (Удобный формат задания времени)
  - Запуск таймера в мс (Время задается в миллисекундах)
  - Остановка таймера
  - Пауза таймера
  - Возобновление таймера
  - Принудительное истекание таймера
  - Проверка состояния таймера
  - Чтение значения оставшегося времени таймера

Библиотека снабжена подробными комментариями.

## Установка
**Установка в директорию с пользовательскими библиотеками (Рекомендуется):**
 1. Скачайте и добавьте директорию **DL_PTimer** в папку с пользовательскими библиотеками вашего проекта (создайте папку, если её нет)
 2. Укажите пути в вашей IDE для директории с заголовочным файлом и файлом реализации
 3. Подключите библиотеку с помощью директивы include:
   ```c
   #include "DL_PTimer.h"  //Если указаны пути в IDE путь можно не прописывать
   ```
 4. Не забудьте заменить в файле **DL_PTimer.h** подключаемую HAL библиотеку на вашу версию МК
   ```c
   #include "stm32f1xx_hal.h"  //Замените на свою версию
   ```
**Установка в корень проекта (Проще):**
  1. Добавьте заголовочный файл **DL_PTimer/DL_PTimer.h** в директорию с вашими заголовочными файлами проекта
  2. Добавьте файл реализации **DL_PTimer/DL_PTimer.c** в директорию с вашими заголовочными файлами проекта
  3. Подключите библиотеку с помощью директивы include:
   ```c
   #include "DL_PTimer.h"  //Если библиотека установлена в корень вашего проекта
   ```
  4. Не забудьте заменить в файле **DL_PTimer.h** подключаемую HAL библиотеку на вашу версию МК
   ```c
   #include "stm32f1xx_hal.h"  //Замените на свою версию
   ```
***Важно:***
***Внимательно проверяйте пути к заголовочному файлу и файлу реализации***
## Использование

Создание экземпляра структуры таймера и запуск таймера с помощью универсальной функции:
```c
DL_PTimer tim = {0};
DL_pTimStart(&tim, "m:s:ms", 1, 0, 50); //Параметры: Структура таймера, Строка формата, Значения соответствующие формату
```
Строка формата представляет собой набор символов, которыми пользователь указывает функции порядок передачи временных значений в последующих параметрах.
Буквы означают следующие единицы измерения времени:
- d-День
- h-Час
- m-Минута
- s-Секунда
- ms-Миллисекунда

В качестве разделителя допустимо использовать ':' и ' ' в любом количестве. Эти символы будут проигнорированы.  
**Максимальный возможный СУММАРНЫЙ временной интервал составляет 49.7 дней**

Примеры запуска таймера с разными интервалами срабатывания:  
***Запуск таймера с интервалом 2 Дня, 3 часа, 48 минут, 50 секунд, 1 миллисекунда***
```c
DL_pTimStart(&tim, "d:h:m:s:ms", 2, 3, 48, 50, 1);
```
***Запуск таймера с интервалом 2 часа, 48 минут***
```c
DL_pTimStart(&tim, "h : m", 2, 48);  //Дополнительные разделители в виде пробелов никак не повлияют
```
***Запуск таймера с интервалом 1 день, 55 секунд***
```c
DL_pTimStart(&tim, "d s", 1, 55);  //Можно пользоваться только пробелами в качестве разделителей
```
Строка формата должна быть в НИЖНЕМ регистре, любые символы кроме допустимых прервут запуск таймера.  

Так же запускать таймер можно более простой функцией, но нужно передавать интервал только в мс:
```c
DL_pTimStartMS(&tim, 500);  //Запуск таймера на 500мс
```
В основной цикл программы добавьте проверку истекания таймера следующим образом:
```c
while (1)
{
  if( DL_pTimExpired(&tim) )  //Должна вызываться как можно чаще
  {
        ... 
        //Сработает единственный раз когда таймер истечет
  }
  ...
}
```
Если нужно, чтобы таймер работал периодично, а не единожды, делайте так:
```c
while (1)
{
  if( DL_pTimExpired(&tim) )  //Должна вызываться как можно чаще
  {
        ...
        DL_pTimStartMS(&tim, 50);  //Повторный запуск таймера
        //Код в условии будет вызываться каждые 50мс
  }
  ...
}
```
Описание всех функций:
```c
void DL_pTimStart(DL_PTimer* ptimer, const char* format, ...);  //Форматная функция запуска таймера
void DL_pTimStartMS(DL_PTimer* ptimer, uint32_t ms);  //Функция запуска таймера в миллисекундах
void DL_pTimStop(DL_PTimer* ptimer);  //Функция для остановки и сброса таймера

void DL_pTimPause(DL_PTimer* ptimer);  //Функция для остановки таймера без сброса
void DL_pTimResume(DL_PTimer* ptimer);  //Функция для запуска таймера без обновления счетчика

void DL_pTimForcedExpiration(DL_PTimer* ptimer);  //Функция принудительного истекания таймера

uint8_t DL_pTimExpired(DL_PTimer* ptimer);  //Функция проверки состояния таймера

uint32_t DL_pTimGetTimeLeft(DL_PTimer* ptimer);  //Функция возврата оставшегося времени
```
## Совместимость
Библиотека написана, протестирована и гарантированно работает на отладочной плате "Blue Pill Plus" на базе МК STM32F103C8T6.
Благодаря использованию HAL, библиотека должна работать на подавляющем большинстве МК STM32.
## Версии
- v1.0
- v1.1
  - Исправлен конфликт между таймерами
  - Добавлена функция форматного задания времени
  - Убраны громоздкие функции, вместо них теперь одна форматная
  - Исправлен расчет времени истекания таймера
  - Добавлена функция возврата значения счетчика таймера

## Обратная связь
Если вы нашли баг, или есть предложения по доработке, пишите мне в [Телеграм - группу](https://t.me/DLeeFB) для обратной связи =)
